@page "/"
@using RobotApp.Components.Layout
@using RobotApp.Models
@using RobotApp.Models.Measurements
@using RobotApp.Repositories
@inject IRobotRepository Robots
@inject IMeasurementRepository Measurements
@rendermode InteractiveServer

<h3>Robot History</h3>

<div class="row g-2 mb-3 align-items-end">
    <div class="col-md-4">
        <label class="form-label">Robot</label>
        <select class="form-select" @bind="SelectedRobot">
            <option value="">Select robot</option>
            @foreach (var r in RobotList)
            {
                <option value="@r.Name">@r.Name</option>
            }
        </select>
    </div>

    <div class="col-md-3">
        <label class="form-label">From</label>
        <input type="datetime-local" class="form-control" @bind="FromUtc" />
    </div>

    <div class="col-md-3">
        <label class="form-label">To</label>
        <input type="datetime-local" class="form-control" @bind="ToUtc" />
    </div>

    <div class="col-md-2">
        <button class="btn btn-primary w-100" @onclick="LoadData">
            Load
        </button>
    </div>
</div>


@if (Temperature.Any())
{
    <TimeSeriesLineChart
        Title="Temperature"
        YAxisLabel="°C"
        Data="Temperature.Select(t => (t.Timestamp, t.Value)).ToList()" />
}

@if (Humidity.Any())
{
    <TimeSeriesLineChart
        Title="Humidity"
        YAxisLabel="%"
        Data="Humidity.Select(h => (h.Timestamp, h.Value)).ToList()" />
}

@if (States.Any())
{
    <h5>📜 State events</h5>
    <ul class="list-group">
        @foreach (var s in States.OrderByDescending(s => s.Timestamp))
        {
            <li class="list-group-item">
                <strong>@s.DisplayState</strong>
                <div>@s.Message</div>
                <small>@s.Timestamp.ToLocalTime()</small>
            </li>
        }
    </ul>
}

@code {
    private List<Robot> RobotList = new();
    private string? SelectedRobot;

    private DateTime FromUtc = DateTime.UtcNow.AddHours(-24);
    private DateTime ToUtc = DateTime.UtcNow;

    private string FromLocal
    {
        get => FromUtc.ToLocalTime().ToString("yyyy-MM-ddTHH:mm");
        set => FromUtc = DateTime.Parse(value).ToUniversalTime();
    }

    private string ToLocal
    {
        get => ToUtc.ToLocalTime().ToString("yyyy-MM-ddTHH:mm");
        set => ToUtc = DateTime.Parse(value).ToUniversalTime();
    }

    private List<TemperatureMeasurement> Temperature = new();
    private List<HumidityMeasurement> Humidity = new();
    private List<StateSnapshot> States = new();

    protected override async Task OnInitializedAsync()
    {
        RobotList = (await Robots.GetAllAsync()).ToList();
    }

    private async Task LoadData()
    {
        if (SelectedRobot is null)
            return;

        Temperature = (await Measurements.GetTemperatureAsync(
            SelectedRobot, FromUtc, ToUtc)).ToList();

        Humidity = (await Measurements.GetHumidityAsync(
            SelectedRobot, FromUtc, ToUtc)).ToList();

        States = (await Measurements.GetStatesAsync(
            SelectedRobot, FromUtc, ToUtc)).ToList();
    }
}
